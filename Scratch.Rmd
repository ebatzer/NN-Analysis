---
title: "R Notebook"
output: html_notebook
---

# Resource Supply and Observational Data

```{r}
com.mat <- plot.sp.mat %>% 
  filter(year_trt == 0) %>%
  select(-c(site_code, year, block, plot, trt, year_trt))

com.attr <- plot.sp.mat %>%
  filter(year_trt == 0) %>%
  select(c(site_code, year, block, plot, trt, year_trt)) %>%
  left_join(soil.chars)

```


```{r, include = FALSE}
# Alternatively, could do the same using CCA
output <- list()
counter <- 1

# For all unique sites selected
for(i in unique(com.attr$site_code)){
  
    # Subset to a single site
    com.subset <- com.mat[com.attr$site_code == i & com.attr$year_trt == 0,]
    
    # Remove all zero columns
    com.subset = com.subset[,colSums(com.subset) > 0]
  
    # Pull out relevant plot attributes for each site
    attr.subset <- data.frame(com.attr) %>% filter(site_code == i & year_trt == 0)
    
    # Check that these two matrices are the same size
    expect_true(nrow(attr.subset) == nrow(com.subset))

    # Standardizing community data matrix (normalized, in this case)
    mat.stdized <- decostand(com.subset, "total")
        
    # Running rda on this data with the 3 axes of environmental variation (N, P, K)
    rda.mod = rda(mat.stdized ~ (N_z + P_z + K_z) , data = attr.subset)
      
    # Saving ouput
    output[[counter]] = list(sitename = i,
                               block = 1,
                               envscores = calibrate(rda.mod),
                               varexp = data.frame(mod = anova(rda.mod)$ChiSquare[1],
                                                   resid = anova(rda.mod)$ChiSquare[2],
                                                   dfmod = anova(rda.mod)$Df[1],
                                                   dfresid = anova(rda.mod)$Df[2],
                                                   pval = anova(rda.mod)$"Pr(>F)"[1]
                                                  ),
                               envvifs = vif.rda(rda.mod))
      
      # Update counter
      counter = counter + 1
    
}
```

### What sites exhibit the greatest proportion of community variance explained by soil nutrient Z-scores?

Here I've run a CCA (may have some favorable properties relative to RDA, but functions similarly) on each site, which should allow us to determine:

* What fraction of the overall variance in observational community composition we can attribute to variation in soil N, P, and K (and to test this fraction with ANOVA)
* What is the estimated relationship between community composition and soil characteristics (plot scores on N, P, and K axes)

Because I've subset our data to just those plots containing 30 plots in three blocks, these comparisons should be done with very similar datasets - similar to Jon Bakker's approach.

Here we see that a number of sites have significant fractions of community variance that can be explained by soil variables in CCA, and there's quite a range therein.

```{r, echo = FALSE}

# Binds coefficients from each site together:

for(sites in 1:length(output)){
  if(sites == 1){
    
    # Nutrient Loading Coefficients:
    coefs = data.frame(output[[sites]]$envscores)
    coefs$site = rep(output[[sites]]$sitename, nrow(coefs))
    coefs$block = rep(output[[sites]]$block, nrow(coefs))
    
    # P - values:
    pvals = data.frame(output[[sites]]$varexp)
    pvals$site = rep(output[[sites]]$sitename, nrow(pvals))
    pvals$block = rep(output[[sites]]$block, nrow(pvals))
    
  }else{
    
    # Nutrient Loading Coefficients
    tojoin = data.frame(output[[sites]]$envscores)
    tojoin$site = rep(output[[sites]]$sitename, nrow(tojoin))
    tojoin$block = rep(output[[sites]]$block, nrow(tojoin))
    coefs = bind_rows(coefs, tojoin)
    
    # P - values:
    tojoin = data.frame(output[[sites]]$varexp)
    tojoin$site = rep(output[[sites]]$sitename, nrow(tojoin))
    tojoin$block = rep(output[[sites]]$block, nrow(tojoin))
    pvals = bind_rows(pvals, tojoin)
  }
}

signif_sites <- pvals$site[pvals$pval <= 0.05]
pvals$varfrac = pvals$mod / (pvals$mod + pvals$resid)

pvals %>% arrange(varfrac) %>% ggplot(aes(x = site,
                     y = mod / (mod + resid),
                     color = pval <= .05)) +
  geom_point() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

```

```{r, echo = FALSE}
p1 = left_join(pvals, soil.means, by = c("site" = "site_code")) %>%
  mutate(CV_n =  pct_N_sd / pct_N_mean,
         CV_p =  ppm_P_sd / ppm_P_mean,
         CV_k =  ppm_K_sd / ppm_K_mean) %>%
  ggplot(aes(x = CV_n,
             y = varfrac)) +
  geom_point(aes(color = site)) +
  guides(color = FALSE)+
  stat_smooth(method = "lm") +
  xlab("Coefficient of Variation - N") +
  ylab("Prop. Obs. Variance")

p2 = left_join(pvals, soil.means, by = c("site" = "site_code")) %>%
  mutate(CV_n =  pct_N_sd / pct_N_mean,
         CV_p =  ppm_P_sd / ppm_P_mean,
         CV_k =  ppm_K_sd / ppm_K_mean) %>%
  ggplot(aes(x = CV_p,
             y = varfrac)) +
  geom_point(aes(color = site)) +
  guides(color = FALSE)+
  stat_smooth(method = "lm") +
  xlab("Coefficient of Variation - P") +
  ylab("Prop. Obs. Variance")

p3 = left_join(pvals, soil.means, by = c("site" = "site_code")) %>%
  mutate(CV_n =  pct_N_sd / pct_N_mean,
         CV_p =  ppm_P_sd / ppm_P_mean,
         CV_k =  ppm_K_sd / ppm_K_mean) %>%
  ggplot(aes(x = CV_k,
             y = varfrac)) +
  geom_point(aes(color = site)) +
  guides(color = FALSE) +
  stat_smooth(method = "lm") +
  xlab("Coefficient of Variation - K") +
  ylab("Prop. Obs. Variance")

gridExtra::grid.arrange(p1, p2, p3, nrow = 2)

dat = left_join(pvals, soil.means, by = c("site" = "site_code")) %>%
  mutate(CV_n =  pct_N_sd / pct_N_mean,
         CV_p =  ppm_P_sd / ppm_P_mean,
         CV_k =  ppm_K_sd / ppm_K_mean)

car::Anova(lm(varfrac ~ CV_n * CV_p * CV_k, data = dat), type=2)
```

```{r, echo = FALSE }
p1 <- coefs %>% 
  ggplot(aes(x = N_z, y = P_z, color = site)) +
  geom_point(alpha = .1) +
  guides(color = FALSE)+
  stat_smooth(method = "lm", se = FALSE) +
  xlab("N Z-score Coefficient ") +
  ylab("P Z-score Coefficient")

p2 <- coefs %>% 
  ggplot(aes(x = N_z, y = K_z, color = site)) +
  geom_point(alpha = .1) +
  guides(color = FALSE)+
  stat_smooth(method = "lm", se = FALSE) +
  xlab("N Z-score Coefficient ") +
  ylab("K Z-score Coefficient")

p3 <- coefs %>% 
  ggplot(aes(x = P_z, y = K_z, color = site)) +
  geom_point(alpha = .1) +
  guides(color = FALSE)+
  stat_smooth(method = "lm", se = FALSE) +
  xlab("P Z-score Coefficient ") +
  ylab("K Z-score Coefficient")

gridExtra::grid.arrange(p1, p2, p3, nrow = 2)

cat(paste("N-P Corr:", cor(coefs$N_z, coefs$P_z),
      "\nN-K Corr:", cor(coefs$N_z, coefs$K_z),
      "\nP-K Corr:", cor(coefs$P_z, coefs$K_z)))
```
